<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>TOEIC 単語理解度チェッカー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }
    .wrap {
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 { font-size: 1.4rem; margin-bottom: 8px; }
    h2 { font-size: 1.1rem; margin-top: 24px; margin-bottom: 8px; }

    .card {
      background: #111827;
      border-radius: 16px;
      padding: 16px;
      margin-top: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    }

    .word-main {
      font-size: 2rem;
      font-weight: 700;
      text-align: center;
      margin: 12px 0 4px;
    }
    .word-sub {
      font-size: 1rem;
      text-align: center;
      opacity: 0.8;
    }

    .btn-row {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    .btn {
      flex: 1;
      padding: 16px 8px;
      border-radius: 999px;
      border: none;
      font-size: 1.2rem;
      font-weight: 600;
      cursor: pointer;
      touch-action: manipulation;
    }
    .btn-yes { background: #16a34a; color: #ecfdf5; }
    .btn-no  { background: #dc2626; color: #fef2f2; }

    .btn-yes:active { opacity: 0.8; transform: scale(0.98); }
    .btn-no:active  { opacity: 0.8; transform: scale(0.98); }

    .info-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      opacity: 0.8;
      margin-top: 8px;
    }

    textarea {
      width: 100%;
      min-height: 140px;
      border-radius: 10px;
      border: 1px solid #374151;
      padding: 8px;
      background: #020617;
      color: #e5e7eb;
      box-sizing: border-box;
      font-family: monospace;
      font-size: 0.9rem;
    }

    .small-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
      background: #334155;
      color: #e5e7eb;
      margin-top: 8px;
    }
    .small-btn:active { opacity: 0.8; }

    .stats {
      font-size: 0.9rem;
      margin-top: 4px;
      line-height: 1.5;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #1f2937;
      margin-left: 4px;
    }

    .hint {
      font-size: 0.8rem;
      opacity: 0.75;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>TOEIC 単語 理解度ワンクリック記録</h1>
    <p style="font-size:0.9rem; opacity:0.8;">
      歩きながら・エアロバイクしながら、<br>
      出てきた単語に対して <strong>「わかる / わからない」</strong> をタップするだけで記録できます。
    </p>

    <!-- 単語入力エリア -->
    <div class="card">
      <h2>① 単語リストの登録</h2>
      <p class="hint">
        1行に1単語で入力してください：<br>
        <code>apple,リンゴ</code> のように「英単語,日本語訳」形式推奨。<br>
        例：1500行分まとめて貼り付けてもOK。
      </p>
      <textarea id="wordInput" placeholder="例&#10;apple,リンゴ&#10;book,本&#10;...&#10;（ここに1500語貼り付け）"></textarea>
      <button class="small-btn" onclick="saveWordList()">この単語リストを保存する</button>
      <div class="stats" id="wordCountInfo"></div>
    </div>

    <!-- 学習画面 -->
    <div class="card">
      <h2>② 学習＆記録</h2>
      <div class="info-row">
        <div>現在の番号: <span id="currentIndex">-</span></div>
        <div>登録単語数: <span id="totalWords">0</span></div>
      </div>

      <div class="word-main" id="wordMain">単語が未登録</div>
      <div class="word-sub" id="wordSub">上で単語リストを保存してください</div>

      <div class="btn-row">
        <button class="btn btn-yes" onclick="recordAnswer('known')">わかる</button>
        <button class="btn btn-no"  onclick="recordAnswer('unknown')">わからない</button>
      </div>

      <div class="info-row" style="margin-top:12px;">
        <div>周回: <span id="roundInfo">0</span></div>
        <div>ランダム順: <span id="modeInfo">OFF</span></div>
      </div>

      <button class="small-btn" onclick="toggleRandomMode()">
        出題順をランダム / 順番 に切り替え
      </button>
      <button class="small-btn" onclick="nextWordManual()">
        次の単語へスキップ
      </button>

      <div class="stats" id="statsArea"></div>
    </div>
  </div>

  <script>
    const STORAGE_WORDS_KEY = "toeic_words_v1";
    const STORAGE_LOGS_KEY  = "toeic_logs_v1";
    const STORAGE_STATE_KEY = "toeic_state_v1";

    let words = [];       // {en, jp}
    let logs = [];        // {time, index, result}
    let state = {         // 学習状態
      currentIndex: 0,
      randomMode: false,
      round: 1
    };

    // ---- 初期化 ----
    function loadFromStorage() {
      try {
        const w = localStorage.getItem(STORAGE_WORDS_KEY);
        const l = localStorage.getItem(STORAGE_LOGS_KEY);
        const s = localStorage.getItem(STORAGE_STATE_KEY);

        words = w ? JSON.parse(w) : [];
        logs  = l ? JSON.parse(l) : [];
        state = s ? JSON.parse(s) : state;
      } catch (e) {
        console.error("load error", e);
        words = [];
        logs = [];
      }
    }

    function saveWords() {
      localStorage.setItem(STORAGE_WORDS_KEY, JSON.stringify(words));
    }
    function saveLogs() {
      localStorage.setItem(STORAGE_LOGS_KEY, JSON.stringify(logs));
    }
    function saveState() {
      localStorage.setItem(STORAGE_STATE_KEY, JSON.stringify(state));
    }

    // ---- 単語リスト保存 ----
    function saveWordList() {
      const text = document.getElementById("wordInput").value;
      const lines = text.split(/\r?\n/).map(line => line.trim()).filter(line => line.length > 0);

      const parsed = lines.map(line => {
        const parts = line.split(",");
        const en = parts[0] ? parts[0].trim() : "";
        const jp = parts[1] ? parts[1].trim() : "";
        return { en, jp };
      }).filter(w => w.en.length > 0);

      if (parsed.length === 0) {
        alert("有効な単語が見つかりませんでした。形式を確認してください。");
        return;
      }

      words = parsed;
      state.currentIndex = 0;
      state.round = 1;
      saveWords();
      saveState();
      updateWordCountInfo();
      renderWord();
      updateStats();
      alert("単語リストを保存しました！（" + words.length + "語）");
    }

    // ---- 出題単語の表示 ----
    function renderWord() {
      const wordMain = document.getElementById("wordMain");
      const wordSub  = document.getElementById("wordSub");
      const currentIndexEl = document.getElementById("currentIndex");
      const totalWordsEl   = document.getElementById("totalWords");
      const roundInfoEl    = document.getElementById("roundInfo");
      const modeInfoEl     = document.getElementById("modeInfo");

      if (words.length === 0) {
        wordMain.textContent = "単語が未登録";
        wordSub.textContent  = "上のテキストエリアに単語を貼り付けて保存してください";
        currentIndexEl.textContent = "-";
        totalWordsEl.textContent   = "0";
        roundInfoEl.textContent    = "0";
        modeInfoEl.textContent     = "OFF";
        return;
      }

      const idx = state.currentIndex % words.length;
      const w   = words[idx];

      wordMain.textContent = w.en || "(英単語なし)";
      wordSub.textContent  = w.jp || "（意味未入力）";
      currentIndexEl.textContent = (idx + 1) + " / " + words.length;
      totalWordsEl.textContent   = String(words.length);
      roundInfoEl.textContent    = String(state.round);
      modeInfoEl.textContent     = state.randomMode ? "ON" : "OFF";
    }

    // ---- 回答を記録 ----
    function recordAnswer(result) {
      if (words.length === 0) return;

      const idx = state.currentIndex % words.length;
      const now = new Date().toISOString(); // 後でCSVにしやすい形式

      logs.push({
        time: now,
        index: idx,
        result: result  // "known" or "unknown"
      });
      saveLogs();

      // 次の単語へ（ランダム or 順番）
      moveNextIndex();
      renderWord();
      updateStats();
    }

    function moveNextIndex() {
      if (words.length === 0) return;
      if (state.randomMode) {
        // ランダムに次のインデックスへ
        const next = Math.floor(Math.random() * words.length);
        state.currentIndex = next;
      } else {
        // 順番に進める
        state.currentIndex++;
        if (state.currentIndex >= words.length) {
          state.currentIndex = 0;
          state.round++;
        }
      }
      saveState();
    }

    function nextWordManual() {
      if (words.length === 0) return;
      moveNextIndex();
      renderWord();
    }

    function toggleRandomMode() {
      state.randomMode = !state.randomMode;
      saveState();
      renderWord();
    }

    // ---- 集計表示 ----
    function updateStats() {
      const statsArea = document.getElementById("statsArea");
      if (words.length === 0) {
        statsArea.textContent = "";
        return;
      }

      // 各単語ごとの最終回答を集計
      const latestByWord = new Map(); // index -> lastResult
      for (const log of logs) {
        latestByWord.set(log.index, log.result);
      }

      let known = 0;
      let unknown = 0;
      for (const [_, result] of latestByWord.entries()) {
        if (result === "known") known++;
        else if (result === "unknown") unknown++;
      }

      const totalAnswered = latestByWord.size;
      const total = words.length;
      const knownRate = totalAnswered ? Math.round((known / totalAnswered) * 100) : 0;

      statsArea.innerHTML =
        `回答済み単語: ${totalAnswered} / ${total}` +
        `<br>「わかる」になっている単語: ${known}` +
        `<span class="badge">${knownRate}%</span>` +
        `<br>「わからない」になっている単語: ${unknown}`;
    }

    function updateWordCountInfo() {
      const wordCountInfo = document.getElementById("wordCountInfo");
      if (words.length === 0) {
        wordCountInfo.textContent = "まだ単語が登録されていません。";
      } else {
        wordCountInfo.textContent = `現在登録されている単語数: ${words.length} 語`;
      }
    }

    // ---- 初期ロード処理 ----
    loadFromStorage();
    updateWordCountInfo();
    renderWord();
    updateStats();

    // 既に単語リストが保存されている時は、テキストエリアには何も入れない（誤上書き防止）
  </script>
</body>
</html>
